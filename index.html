<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Policy Management System</title>

    <!-- Modern Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* Modern Corporate Color Palette */
            --primary-blue: #1E40AF;
            --primary-blue-hover: #1D4ED8;
            --primary-blue-light: #DBEAFE;
            --secondary-indigo: #6366F1;
            --accent-emerald: #10B981;
            --accent-emerald-hover: #059669;
            --warning-amber: #F59E0B;
            --danger-red: #EF4444;
            --danger-red-hover: #DC2626;

            /* Neutral Grays */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;

            /* Semantic Colors */
            --background-primary: #FFFFFF;
            --background-secondary: var(--gray-50);
            --background-tertiary: var(--gray-100);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-700);
            --text-tertiary: var(--gray-500);
            --border-color: var(--gray-200);
            --border-hover: var(--gray-300);

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 200ms ease-in-out;
            --transition-slow: 300ms ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        /* Login Page - Enhanced */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-indigo) 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
            opacity: 0.1;
        }

        .login-card {
            background: var(--background-primary);
            padding: 48px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 420px;
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo i {
            font-size: 48px;
            color: var(--primary-blue);
            margin-bottom: 16px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
        }

        .login-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: var(--background-primary);
            color: var(--text-primary);
            transition: all var(--transition-normal);
            font-family: inherit;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', 'Monaco', 'Menlo', monospace;
            line-height: 1.5;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
            transform: translateY(-1px);
        }

        .form-input:hover,
        .form-textarea:hover,
        .form-select:hover {
            border-color: var(--border-hover);
        }

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            gap: 8px;
            white-space: nowrap;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        /* Add this CSS to your index.html <style> section */

        .btn-danger.group-delete {
            background: linear-gradient(135deg, var(--danger-red), #B91C1C);
            border: 2px solid var(--danger-red);
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger.group-delete:hover {
            background: linear-gradient(135deg, #B91C1C, #991B1B);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .btn-danger.group-delete i {
            color: #FEE2E2;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            background: var(--primary-blue-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--background-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            border-color: var(--border-hover);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--accent-emerald);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover {
            background: var(--accent-emerald-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: var(--warning-amber);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-warning:hover {
            background: #D97706;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover {
            background: var(--danger-red-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 18px 32px;
            font-size: 16px;
        }

        /* Main App Layout */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-header {
            background: var(--background-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(8px);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-logo i {
            font-size: 28px;
            color: var(--primary-blue);
        }

        .app-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-indigo));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-nav {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--background-tertiary);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
        }

        .user-info i {
            color: var(--primary-blue);
        }

        /* Dashboard */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        .dashboard-header {
            margin-bottom: 32px;
        }

        .dashboard-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--background-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Enhanced Controls */
        .controls-section {
            background: var(--background-primary);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .controls-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .controls-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 2fr 200px 200px 200px auto auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--background-primary);
            transition: all var(--transition-normal);
        }

        .search-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 16px;
        }

        /* Enhanced Endorsements */
        .endorsements-section {
            background: var(--background-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .endorsements-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--background-tertiary);
        }

        .endorsements-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .endorsements-count {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--background-primary);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .endorsements-list {
            max-height: 700px;
            overflow-y: auto;
        }

        /* Enhanced Endorsement Items */
        .endorsement-item {
            display: grid;
            grid-template-columns: 1fr 150px 120px 140px 120px 100px;
            gap: 20px;
            padding: 20px 32px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-normal);
            align-items: center;
            position: relative;
        }

        .endorsement-item:hover {
            background: var(--background-secondary);
            transform: translateX(4px);
        }

        .endorsement-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-blue);
            transform: scaleY(0);
            transition: transform var(--transition-normal);
        }

        .endorsement-item:hover::before {
            transform: scaleY(1);
        }

        .endorsement-main {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .endorsement-policy {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 16px;
        }

        .endorsement-type {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .endorsement-meta {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .combination-badge {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-indigo));
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-lg);
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: var(--radius-lg);
            font-size: 12px;
            font-weight: 600;
            gap: 6px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .status-approved {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-emerald);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-review {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-amber);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* Enhanced Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-container {
            background: var(--background-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--background-tertiary);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: var(--background-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            transition: all var(--transition-normal);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--danger-red);
            border-color: var(--danger-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        /* Enhanced Combination Selector */
        .combination-selector {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            background: var(--background-secondary);
        }

        .combination-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .combination-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .edit-mode-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .edit-toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--gray-300);
            border-radius: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .edit-toggle-switch.active {
            background: var(--primary-blue);
        }

        .edit-toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .edit-toggle-switch.active::before {
            transform: translateX(24px);
        }

        .combination-tabs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .combination-tab {
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--background-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .combination-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .combination-tab:hover::before {
            left: 100%;
        }

        .combination-tab.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
        }

        .combination-tab:hover:not(.active) {
            background: var(--background-secondary);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
        }

        /* Enhanced Field Display */
        .fields-section {
            padding: 32px;
        }

        .fields-actions {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--background-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .status-editor {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-editor select {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--background-primary);
            font-weight: 600;
            transition: all var(--transition-normal);
        }

        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .field-item {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            transition: all var(--transition-normal);
            position: relative;
        }

        .field-item:hover {
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .field-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .field-value {
            font-size: 15px;
            color: var(--text-primary);
            word-break: break-word;
            min-height: 24px;
            line-height: 1.5;
        }

        .field-value.empty {
            color: var(--text-tertiary);
            font-style: italic;
        }

        .field-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: var(--background-primary);
            color: var(--text-primary);
            transition: all var(--transition-normal);
            font-family: inherit;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }

        .field-edit-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all var(--transition-normal);
            opacity: 0;
        }

        .field-item:hover .field-edit-icon {
            opacity: 1;
        }

        .field-edit-icon:hover {
            color: var(--primary-blue);
            transform: scale(1.1);
        }

        /* Modal Footer */
        .modal-footer {
            padding: 32px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 16px;
            justify-content: space-between;
            background: var(--background-tertiary);
        }

        .footer-left,
        .footer-right {
            display: flex;
            gap: 16px;
        }

        /* Messages */
        .message {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .message i {
            font-size: 18px;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-emerald);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading States */
        .loading-state,
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px 24px;
            text-align: center;
            color: var(--text-secondary);
        }

        .loading-state i,
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--text-tertiary);
        }

        .loading-state i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .endorsement-item {
                grid-template-columns: 1fr auto;
                gap: 12px;
            }

            .field-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .login-card {
                padding: 32px 24px;
                margin: 16px;
            }

            .modal-container {
                margin: 10px;
                max-height: 95vh;
            }

            .app-header {
                padding: 16px 20px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h1 class="login-title">Corporate Policy Hub</h1>
            <p class="login-subtitle">Advanced endorsement management platform</p>

            <div id="loginError" class="message message-error">
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" name="username" class="form-input" required
                        placeholder="Enter your username">
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" name="password" class="form-input" required
                        placeholder="Enter your password">
                </div>

                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In to Platform
                </button>
            </form>

            <div style="margin-top: 32px; text-align: center; color: var(--text-tertiary); font-size: 12px;">
                Default credentials: admin / admin123
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Enhanced Header -->
        <header class="app-header">
            <div class="app-logo">
                <i class="fas fa-shield-alt"></i>
                <span class="app-title">Corporate Policy Hub</span>
            </div>

            <nav class="app-nav">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="currentUserName">Admin User</span>
                </div>
                <button id="logoutBtn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </nav>
        </header>

        <!-- Enhanced Dashboard -->
        <main class="dashboard-container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Multi-Combination Endorsements</h1>
                <p class="dashboard-subtitle">Manage and edit policy endorsements with comprehensive multi-combination
                    support</p>

                <!-- Time Display Widget -->
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div
                        style="background: var(--background-primary); padding: 12px 20px; border-radius: var(--radius-md); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Current Local
                            Time</div>
                        <div id="currentTime" style="font-size: 14px; font-weight: 600; color: var(--primary-blue);">
                            Loading...</div>
                    </div>
                    <div
                        style="background: var(--background-primary); padding: 12px 20px; border-radius: var(--radius-md); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Server Time Sync
                        </div>
                        <div id="serverTimeStatus"
                            style="font-size: 14px; font-weight: 600; color: var(--accent-emerald);">Checking...</div>
                    </div>
                    <div
                        style="background: var(--background-primary); padding: 12px 20px; border-radius: var(--radius-md); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Welcome Back
                        </div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--accent-emerald);">aadi6112</div>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="dashboard-stats">

                    <!-- Stats Dashboard -->
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalEndorsements">0</div>
                            <div class="stat-label">Total Endorsement Groups</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="approvedEndorsements">0</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingEndorsements">0</div>
                            <div class="stat-label">In Review</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rejectedEndorsements">0</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Controls -->
                <div class="controls-section">
                    <div class="controls-header">
                        <h2 class="controls-title">Search & Filter Controls</h2>
                    </div>

                    <div class="controls-grid">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input"
                                placeholder="Search by policy number or endorsement type...">
                        </div>

                        <div>
                            <label class="form-label">Status Filter</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="In Review">In Review</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Type Filter</label>
                            <select id="typeFilter" class="form-select">
                                <option value="">All Types</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Sort By</label>
                            <select id="sortBy" class="form-select">
                                <option value="created_at">Date Created</option>
                                <option value="policy_number">Policy Number</option>
                                <option value="endorsement_type">Type</option>
                                <option value="status">Status</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Excel Upload</label>
                            <button id="uploadBtn" class="btn btn-primary">
                                <i class="fas fa-upload"></i>
                                Upload Excel
                            </button>
                            <input type="file" id="fileInput" accept=".xlsx,.xls,.json">
                        </div>

                        <div>
                            <label class="form-label">JSON Upload</label>
                            <button id="jsonUploadBtn" class="btn btn-success">
                                <i class="fas fa-code"></i>
                                Upload JSON
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="successMessage" class="message message-success">
                    <i class="fas fa-check-circle"></i>
                    <span></span>
                </div>
                <div id="errorMessage" class="message message-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span></span>
                </div>

                <!-- Enhanced Endorsements List -->
                <div class="endorsements-section">
                    <div class="endorsements-header">
                        <h2 class="endorsements-title">Endorsement Groups</h2>
                        <span id="endorsementsCount" class="endorsements-count">0 groups</span>
                    </div>

                    <div class="endorsements-list" id="endorsementsList">
                        <div id="loadingState" class="loading-state">
                            <i class="fas fa-spinner"></i>
                            <h3>Loading endorsements...</h3>
                            <p>Please wait while we fetch your data</p>
                        </div>

                        <div id="emptyState" class="empty-state" style="display: none;">
                            <i class="fas fa-file-alt"></i>
                            <h3>No endorsements found</h3>
                            <p>Upload your first endorsement file to get started with the system</p>
                            <button class="btn btn-primary" onclick="document.getElementById('uploadBtn').click()"
                                style="margin-top: 16px;">
                                <i class="fas fa-upload"></i>
                                Upload First File
                            </button>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <!-- Enhanced Endorsement Modal with Edit Functionality -->
    <div id="endorsementModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Endorsement Details</h2>
                <button id="closeModal" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Enhanced Combination Selector with Edit Toggle -->
            <div id="combinationSelector" class="combination-selector" style="display: none;">
                <div class="combination-header">
                    <h3 class="combination-title">Available Combinations</h3>
                    <div class="edit-mode-toggle">
                        <span style="font-size: 14px; color: var(--text-secondary);">Edit Mode</span>
                        <div class="edit-toggle-switch" id="editModeToggle"></div>
                    </div>
                </div>
                <div class="combination-tabs" id="combinationTabs">
                    <!-- Dynamic tabs will be inserted here -->
                </div>
            </div>

            <div class="modal-content">
                <div id="modalLoading" class="loading-state">
                    <i class="fas fa-spinner"></i>
                    <span>Loading combinations...</span>
                </div>

                <div id="modalContent" class="fields-section" style="display: none;">
                    <!-- Status Editor -->
                    <div class="fields-actions">
                        <div class="status-editor">
                            <label style="font-weight: 600; color: var(--text-primary);">Status:</label>
                            <select id="statusEditor" class="form-select" style="width: auto;">
                                <option value="In Review">In Review</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                            <button id="saveStatusBtn" class="btn btn-primary btn-sm" style="display: none;">
                                <i class="fas fa-save"></i>
                                Save Status
                            </button>
                        </div>
                    </div>

                    <div id="fieldsGrid" class="field-grid">
                        <!-- Dynamic fields will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="footer-left">
                    <button id="saveAllBtn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-save"></i>
                        Save All Changes
                    </button>
                    <button id="cancelEditBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-times"></i>
                        Cancel Changes
                    </button>
                </div>
                <div class="footer-right">
                    <button id="deleteBtn" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                    <button id="closeModalBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Upload Modal -->
    <div id="jsonUploadModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Upload JSON Data</h2>
                <button id="closeJsonModal" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-content">
                <div style="padding: 32px;">
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">
                        Paste your JSON data with the same field structure as your Excel files.
                        You can upload a single endorsement object or an array of endorsements.
                    </p>

                    <div class="form-group">
                        <label class="form-label">JSON Data</label>
                        <textarea id="jsonTextArea" class="form-textarea" placeholder='Example:
{
  "Número de póliza": "1234567",
  "Nombre del endoso": "LITOTRIPSIA",
  "Versión del endoso inicial": "288",
  "Ramo": "Salud",
  "Elegibilidad": "SELF, PARTNER, CHILD"
}'></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="footer-left"></div>
                <div class="footer-right">
                    <button id="cancelJsonUpload" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button id="submitJsonUpload" class="btn btn-primary">
                        <i class="fas fa-upload"></i>
                        Upload JSON Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Continue with JavaScript in next part... -->
    <script>
        // Enhanced Application State with Edit Mode
        let currentUser = null;
        let endorsements = [];
        let allEndorsementTypes = [];
        let currentCombinations = [];
        let currentCombinationIndex = 0;
        let isEditMode = false;
        let originalFieldValues = {};
        let hasUnsavedChanges = false;
        let currentEndorsementId = null;

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserName = document.getElementById('currentUserName');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');
        const sortBy = document.getElementById('sortBy');
        const uploadBtn = document.getElementById('uploadBtn');
        const jsonUploadBtn = document.getElementById('jsonUploadBtn');
        const fileInput = document.getElementById('fileInput');
        const endorsementsList = document.getElementById('endorsementsList');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const endorsementsCount = document.getElementById('endorsementsCount');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // Stats elements
        const totalEndorsements = document.getElementById('totalEndorsements');
        const approvedEndorsements = document.getElementById('approvedEndorsements');
        const pendingEndorsements = document.getElementById('pendingEndorsements');
        const rejectedEndorsements = document.getElementById('rejectedEndorsements');

        // Enhanced Modal elements
        const modal = document.getElementById('endorsementModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalLoading = document.getElementById('modalLoading');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const combinationSelector = document.getElementById('combinationSelector');
        const combinationTabs = document.getElementById('combinationTabs');
        const fieldsGrid = document.getElementById('fieldsGrid');

        // Edit mode elements
        const editModeToggle = document.getElementById('editModeToggle');
        const statusEditor = document.getElementById('statusEditor');
        const saveStatusBtn = document.getElementById('saveStatusBtn');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        // JSON Upload Modal elements
        const jsonModal = document.getElementById('jsonUploadModal');
        const closeJsonModal = document.getElementById('closeJsonModal');
        const jsonTextArea = document.getElementById('jsonTextArea');
        const cancelJsonUpload = document.getElementById('cancelJsonUpload');
        const submitJsonUpload = document.getElementById('submitJsonUpload');

        // Enhanced API Functions
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || error.message || 'Request failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Authentication Functions
        async function login(username, password) {
            const result = await apiCall('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (result.success) {
                document.cookie = `session_token=${result.session_token}; path=/; max-age=86400`;
                currentUser = result.user;
                showApp();
            } else {
                throw new Error(result.message);
            }
        }

        async function logout() {
            try {
                await apiCall('/api/auth/logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout error:', error);
            }

            document.cookie = 'session_token=; path=/; max-age=0';
            currentUser = null;
            showLogin();
        }

        // UI Functions
        function showLogin() {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function showApp() {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'block';
            currentUserName.textContent = currentUser?.full_name || currentUser?.username || 'User';
            initDashboard();
            async function initDashboard() {
                await Promise.all([
                    loadEndorsements(),
                    loadEndorsementTypes()
                ]);

                // Add this line:
                checkServerTime();
            }
        }

        function showMessage(message, isError = false) {
            const messageEl = isError ? errorMessage : successMessage;
            const otherEl = isError ? successMessage : errorMessage;

            otherEl.style.display = 'none';
            messageEl.querySelector('span').textContent = message;
            messageEl.style.display = 'flex';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Enhanced Data Functions with Stats
        async function loadEndorsements() {
            try {
                loadingState.style.display = 'flex';
                emptyState.style.display = 'none';

                const params = new URLSearchParams({
                    status: statusFilter.value,
                    endorsement_type: typeFilter.value,
                    search_term: searchInput.value,
                    sort_by: sortBy.value,
                    sort_order: 'DESC',
                    grouped: 'true',
                    limit: '100'
                });

                const result = await apiCall(`/api/endorsements?${params}`);
                endorsements = result.data || [];

                renderEndorsements();
                updateStats();
                updateCount();
            } catch (error) {
                showMessage('Failed to load endorsements: ' + error.message, true);
                endorsements = [];
                renderEndorsements();
            } finally {
                loadingState.style.display = 'none';
            }
        }

        function updateStats() {
            const total = endorsements.length;
            const approved = endorsements.filter(e => e.status === 'Approved').length;
            const pending = endorsements.filter(e => e.status === 'In Review').length;
            const rejected = endorsements.filter(e => e.status === 'Rejected').length;

            // Animate counter updates
            animateCounter(totalEndorsements, total);
            animateCounter(approvedEndorsements, approved);
            animateCounter(pendingEndorsements, pending);
            animateCounter(rejectedEndorsements, rejected);
        }

        function animateCounter(element, target) {
            const current = parseInt(element.textContent) || 0;
            const increment = target > current ? 1 : -1;
            const timer = setInterval(() => {
                const value = parseInt(element.textContent) || 0;
                if (value === target) {
                    clearInterval(timer);
                } else {
                    element.textContent = value + increment;
                }
            }, 50);
        }

        async function loadEndorsementTypes() {
            try {
                const result = await apiCall('/api/search/endorsement-types');
                allEndorsementTypes = result.data || [];
                populateTypeFilter();
            } catch (error) {
                console.error('Failed to load endorsement types:', error);
            }
        }

        function populateTypeFilter() {
            typeFilter.innerHTML = '<option value="">All Types</option>';
            allEndorsementTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
        }

        function renderEndorsements() {
            if (endorsements.length === 0) {
                endorsementsList.innerHTML = '';
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            const html = endorsements.map(endorsement => `
                <div class="endorsement-item" onclick="viewEndorsementCombinations('${endorsement.policy_number}', '${endorsement.endorsement_type}')">
                    <div class="endorsement-main">
                        <div class="endorsement-policy">Policy #${endorsement.policy_number || 'N/A'}</div>
                        <div class="endorsement-type">${endorsement.endorsement_type || 'Unknown Type'}</div>
                        <div class="endorsement-meta">Version: ${endorsement.endorsement_version || 'N/A'} • Created: ${formatDate(endorsement.created_at)}</div>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 13px;">${endorsement.concepto_id || 'N/A'}</div>
                    <div style="color: var(--text-secondary); font-size: 13px;">${endorsement.endorsement_validity || 'N/A'}</div>
                    <div style="color: var(--text-tertiary); font-size: 12px;">${formatDate(endorsement.updated_at)}</div>
                    <div>
                        <span class="combination-badge">${endorsement.combination_count || 1} combinations</span>
                    </div>
                    <div>
                        <span class="status-badge status-${getStatusClass(endorsement.status)}">
                            <i class="fas ${getStatusIcon(endorsement.status)}"></i>
                            ${endorsement.status}
                        </span>
                    </div>
                </div>
            `).join('');

            endorsementsList.innerHTML = html;
        }

        function updateCount() {
            endorsementsCount.textContent = `${endorsements.length} endorsement groups`;
        }

        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'approved': return 'approved';
                case 'rejected': return 'rejected';
                default: return 'review';
            }
        }

        function getStatusIcon(status) {
            switch (status?.toLowerCase()) {
                case 'approved': return 'fa-check-circle';
                case 'rejected': return 'fa-times-circle';
                default: return 'fa-clock';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';

            try {
                let date;
                // Handle different date formats
                if (dateString.includes('T')) {
                    // ISO format (2025-08-18T19:36:37Z)
                    date = new Date(dateString);
                } else if (dateString.includes('-') && dateString.includes(':')) {
                    // Local SQLite format (2025-08-18 19:36:37)
                    date = new Date(dateString.replace(' ', 'T'));
                } else {
                    date = new Date(dateString);
                }

                // Format in local time with readable format
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true  // 12-hour format with AM/PM
                });
            } catch (error) {
                console.error('Date formatting error:', error, 'Input:', dateString);
                return dateString; // Return original if parsing fails
            }
        }

        // Enhanced Modal Functions with Edit Mode
        async function viewEndorsementCombinations(policyNumber, endorsementType) {
            modal.style.display = 'flex';
            modalLoading.style.display = 'flex';
            modalContent.style.display = 'none';
            combinationSelector.style.display = 'none';

            // Reset edit mode
            setEditMode(false);

            modalTitle.textContent = `${endorsementType} - Policy #${policyNumber}`;

            try {
                const result = await apiCall(`/api/endorsements/${encodeURIComponent(policyNumber)}/${encodeURIComponent(endorsementType)}/combinations`);
                if (result.success) {
                    currentCombinations = result.data;
                    currentCombinationIndex = 0;
                    currentEndorsementId = currentCombinations[0]?.id;

                    setupCombinationTabs();
                    showCombination(0);
                    modalLoading.style.display = 'none';
                    modalContent.style.display = 'block';
                    if (currentCombinations.length > 1) {
                        combinationSelector.style.display = 'block';
                    }
                } else {
                    throw new Error(result.message || 'Failed to load combinations');
                }
            } catch (error) {
                showMessage('Failed to load combinations: ' + error.message, true);
                closeModalFunction();
            }
        }

        function setupCombinationTabs() {
            combinationTabs.innerHTML = '';
            currentCombinations.forEach((combo, index) => {
                const tab = document.createElement('button');
                tab.className = `combination-tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = `Combination ${combo.combination_number}`;
                tab.onclick = () => showCombination(index);
                combinationTabs.appendChild(tab);
            });
            // Update delete button text based on combination count
            const totalCombinations = currentCombinations.length;
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                if (totalCombinations > 1) {
                    deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete All ${totalCombinations} Combinations`;
                    deleteBtn.style.background = 'var(--danger-red)';
                    deleteBtn.title = `This will delete all ${totalCombinations} combinations for this endorsement`;
                } else {
                    deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Endorsement`;
                    deleteBtn.title = 'Delete this endorsement';
                }
            }

        }

        function showCombination(index) {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Are you sure you want to switch combinations?')) {
                return;
            }

            currentCombinationIndex = index;
            currentEndorsementId = currentCombinations[index]?.id;
            const combination = currentCombinations[index];

            // Update active tab
            document.querySelectorAll('.combination-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            // Update status editor
            statusEditor.value = combination.status || 'In Review';

            // Display Spanish fields with edit capability
            displaySpanishFields(combination.spanish_fields, combination.id);
        }

        function displaySpanishFields(spanishFields, endorsementId) {
            fieldsGrid.innerHTML = '';
            originalFieldValues = {};

            if (!spanishFields || Object.keys(spanishFields).length === 0) {
                fieldsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>No fields found</h3>
                        <p>This combination has no data to display</p>
                    </div>
                `;
                return;
            }

            // Display all Spanish fields with edit capability
            Object.entries(spanishFields).forEach(([fieldName, fieldValue]) => {
                const fieldId = `field_${fieldName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                originalFieldValues[fieldName] = fieldValue;

                const fieldElement = document.createElement('div');
                fieldElement.className = 'field-item';
                fieldElement.setAttribute('data-field-name', fieldName);

                const isEmpty = !fieldValue || fieldValue === '' || fieldValue === 'N/A';

                fieldElement.innerHTML = `
                    <div class="field-name">${fieldName}</div>
                    <div class="field-value-container">
                        <div class="field-value ${isEmpty ? 'empty' : ''}" id="${fieldId}_display">
                            ${isEmpty ? 'No data' : String(fieldValue)}
                        </div>
                        <input type="text" class="field-input" id="${fieldId}_input" 
                               value="${fieldValue || ''}" style="display: none;">
                    </div>
                    <i class="fas fa-edit field-edit-icon" onclick="toggleFieldEdit('${fieldName}', '${fieldId}')"></i>
                `;

                fieldsGrid.appendChild(fieldElement);
            });
        }

        function toggleFieldEdit(fieldName, fieldId) {
            if (!isEditMode) {
                setEditMode(true);
            }

            const displayEl = document.getElementById(`${fieldId}_display`);
            const inputEl = document.getElementById(`${fieldId}_input`);

            if (displayEl.style.display === 'none') {
                // Save and show display
                const newValue = inputEl.value;
                displayEl.textContent = newValue || 'No data';
                displayEl.className = `field-value ${!newValue ? 'empty' : ''}`;
                displayEl.style.display = 'block';
                inputEl.style.display = 'none';

                // Check if value changed
                if (originalFieldValues[fieldName] !== newValue) {
                    hasUnsavedChanges = true;
                    updateSaveButtons();
                }
            } else {
                // Show input for editing
                displayEl.style.display = 'none';
                inputEl.style.display = 'block';
                inputEl.focus();
                inputEl.select();
            }
        }

        function setEditMode(enabled) {
            isEditMode = enabled;
            editModeToggle.classList.toggle('active', enabled);

            // Show/hide edit controls
            saveAllBtn.style.display = enabled ? 'block' : 'none';
            cancelEditBtn.style.display = enabled ? 'block' : 'none';

            // Update field edit icons visibility
            document.querySelectorAll('.field-edit-icon').forEach(icon => {
                icon.style.opacity = enabled ? '1' : '0';
            });

            if (!enabled) {
                hasUnsavedChanges = false;
                // Reset all fields to display mode
                document.querySelectorAll('.field-input').forEach(input => {
                    input.style.display = 'none';
                });
                document.querySelectorAll('.field-value').forEach(display => {
                    display.style.display = 'block';
                });
            }
        }

        function updateSaveButtons() {
            if (hasUnsavedChanges) {
                saveAllBtn.style.display = 'block';
                cancelEditBtn.style.display = 'block';
            }
        }

        async function saveAllChanges() {
            if (!currentEndorsementId) {
                showMessage('No endorsement selected for saving', true);
                return;
            }

            try {
                // Collect all field changes
                const updatedFields = {};
                const fieldElements = document.querySelectorAll('[data-field-name]');

                fieldElements.forEach(element => {
                    const fieldName = element.getAttribute('data-field-name');
                    const input = element.querySelector('.field-input');
                    if (input) {
                        updatedFields[fieldName] = input.value;
                    }
                });

                // Get current combination to preserve other data
                const currentCombination = currentCombinations[currentCombinationIndex];

                const updateData = {
                    policy_number: currentCombination.policy_number,
                    endorsement_type: currentCombination.endorsement_type,
                    endorsement_version: currentCombination.endorsement_version,
                    endorsement_validity: currentCombination.endorsement_validity,
                    concepto_id: currentCombination.concepto_id,
                    status: currentCombination.status,
                    spanish_fields: updatedFields,
                    json_data: updatedFields
                };

                const result = await apiCall(`/api/endorsements/${currentEndorsementId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                if (result.success) {
                    showMessage('Endorsement updated successfully!');

                    // Update current combination with new data
                    currentCombinations[currentCombinationIndex] = result.data;

                    // Refresh the display
                    displaySpanishFields(result.data.spanish_fields, currentEndorsementId);

                    // Reset edit mode
                    setEditMode(false);

                    // Refresh main list
                    loadEndorsements();
                } else {
                    throw new Error(result.message || 'Failed to update endorsement');
                }
            } catch (error) {
                showMessage('Failed to save changes: ' + error.message, true);
            }
        }

        async function saveStatus() {
            if (!currentEndorsementId) {
                showMessage('No endorsement selected for status update', true);
                return;
            }

            try {
                const currentCombination = currentCombinations[currentCombinationIndex];
                const newStatus = statusEditor.value;

                const updateData = {
                    policy_number: currentCombination.policy_number,
                    endorsement_type: currentCombination.endorsement_type,
                    endorsement_version: currentCombination.endorsement_version,
                    endorsement_validity: currentCombination.endorsement_validity,
                    concepto_id: currentCombination.concepto_id,
                    status: newStatus,
                    spanish_fields: currentCombination.spanish_fields,
                    json_data: currentCombination.json_data
                };

                const result = await apiCall(`/api/endorsements/${currentEndorsementId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                if (result.success) {
                    showMessage(`Status updated to ${newStatus} successfully!`);

                    // Update current combination
                    currentCombinations[currentCombinationIndex] = result.data;

                    // Hide save button
                    saveStatusBtn.style.display = 'none';

                    // Refresh main list
                    loadEndorsements();
                } else {
                    throw new Error(result.message || 'Failed to update status');
                }
            } catch (error) {
                showMessage('Failed to save status: ' + error.message, true);
            }
        }

        // Replace the existing deleteEndorsement function in your index.html

        async function deleteEndorsement() {
            if (!currentCombinations || currentCombinations.length === 0) {
                showMessage('No endorsement selected for deletion', true);
                return;
            }

            const firstCombination = currentCombinations[0];
            const policyNumber = firstCombination.policy_number;
            const endorsementType = firstCombination.endorsement_type;
            const totalCombinations = currentCombinations.length;

            // Enhanced confirmation dialog
            const confirmMessage = totalCombinations > 1
                ? `Are you sure you want to delete this ENTIRE endorsement group?\n\n` +
                `• Policy: ${policyNumber}\n` +
                `• Type: ${endorsementType}\n` +
                `• This will DELETE ALL ${totalCombinations} combinations\n\n` +
                `This action cannot be undone!`
                : `Are you sure you want to delete this endorsement?\n\n` +
                `• Policy: ${policyNumber}\n` +
                `• Type: ${endorsementType}\n\n` +
                `This action cannot be undone!`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Delete the entire group
                const result = await apiCall(
                    `/api/endorsements/${encodeURIComponent(policyNumber)}/${encodeURIComponent(endorsementType)}/group`,
                    { method: 'DELETE' }
                );

                if (result.success) {
                    const deletedCount = result.data.deleted_combinations;
                    showMessage(`Successfully deleted endorsement group! (${deletedCount} combinations removed)`);
                    closeModalFunction();
                    loadEndorsements();
                } else {
                    throw new Error(result.message || 'Failed to delete endorsement group');
                }
            } catch (error) {
                showMessage('Failed to delete endorsement group: ' + error.message, true);
            }
        }

        function cancelChanges() {
            if (hasUnsavedChanges && !confirm('Are you sure you want to cancel all changes?')) {
                return;
            }

            // Reset to original values
            Object.entries(originalFieldValues).forEach(([fieldName, originalValue]) => {
                const fieldId = `field_${fieldName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const inputEl = document.getElementById(`${fieldId}_input`);
                const displayEl = document.getElementById(`${fieldId}_display`);

                if (inputEl && displayEl) {
                    inputEl.value = originalValue || '';
                    displayEl.textContent = originalValue || 'No data';
                    displayEl.className = `field-value ${!originalValue ? 'empty' : ''}`;
                }
            });

            setEditMode(false);
        }

        function closeModalFunction() {
            if (hasUnsavedChanges && !confirm('You have unsaved changes. Are you sure you want to close?')) {
                return;
            }

            modal.style.display = 'none';
            currentCombinations = [];
            currentCombinationIndex = 0;
            currentEndorsementId = null;
            setEditMode(false);
        }

        // File Upload Functions
        async function uploadFile(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/files/upload', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const result = await response.json();

                if (result.success) {
                    showMessage(`${result.message} (${result.data.combinations_created} combinations created)`);
                    loadEndorsements();
                    loadEndorsementTypes();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showMessage('Upload failed: ' + error.message, true);
            }
        }

        // Enhanced JSON Upload Functions
        function showJsonUploadModal() {
            jsonModal.style.display = 'flex';
            jsonTextArea.value = '';
            jsonTextArea.focus();
        }

        function closeJsonUploadModal() {
            jsonModal.style.display = 'none';
            jsonTextArea.value = '';
        }

        async function uploadJsonData() {
            const jsonText = jsonTextArea.value.trim();

            if (!jsonText) {
                showMessage('Please enter JSON data', true);
                return;
            }

            try {
                // Validate JSON format
                JSON.parse(jsonText);

                const formData = new FormData();
                formData.append('json_text', jsonText);

                const response = await fetch('/api/files/upload-json', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'JSON upload failed');
                }

                const result = await response.json();

                if (result.success) {
                    showMessage(`${result.message} (${result.data.combinations_created} combinations created)`);
                    closeJsonUploadModal();
                    loadEndorsements();
                    loadEndorsementTypes();
                } else {
                    throw new Error(result.message);
                }

            } catch (parseError) {
                if (parseError instanceof SyntaxError) {
                    showMessage('Invalid JSON format. Please check your syntax.', true);
                } else {
                    showMessage('JSON upload failed: ' + parseError.message, true);
                }
            }
        }

        // Initialize Dashboard
        async function initDashboard() {
            await Promise.all([
                loadEndorsements(),
                loadEndorsementTypes()
            ]);
        }

        // Enhanced Event Listeners
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                loginError.style.display = 'none';
                await login(username, password);
            } catch (error) {
                loginError.querySelector('span').textContent = error.message;
                loginError.style.display = 'flex';
            }
        });

        logoutBtn.addEventListener('click', logout);

        // Filter and search
        searchInput.addEventListener('input', debounce(loadEndorsements, 300));
        statusFilter.addEventListener('change', loadEndorsements);
        typeFilter.addEventListener('change', loadEndorsements);
        sortBy.addEventListener('change', loadEndorsements);

        // File upload
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
                fileInput.value = '';
            }
        });

        // JSON upload
        jsonUploadBtn.addEventListener('click', showJsonUploadModal);
        submitJsonUpload.addEventListener('click', uploadJsonData);
        cancelJsonUpload.addEventListener('click', closeJsonUploadModal);
        closeJsonModal.addEventListener('click', closeJsonUploadModal);

        // Enhanced Modal events
        closeModal.addEventListener('click', closeModalFunction);
        closeModalBtn.addEventListener('click', closeModalFunction);

        // Edit mode toggle
        editModeToggle.addEventListener('click', () => {
            setEditMode(!isEditMode);
        });

        // Status editor
        statusEditor.addEventListener('change', (e) => {
            const currentCombination = currentCombinations[currentCombinationIndex];
            if (e.target.value !== currentCombination.status) {
                saveStatusBtn.style.display = 'inline-flex';
            } else {
                saveStatusBtn.style.display = 'none';
            }
        });

        saveStatusBtn.addEventListener('click', saveStatus);

        // Edit control buttons
        saveAllBtn.addEventListener('click', saveAllChanges);
        cancelEditBtn.addEventListener('click', cancelChanges);
        deleteBtn.addEventListener('click', deleteEndorsement);

        // Close modals on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModalFunction();
            }
        });

        jsonModal.addEventListener('click', (e) => {
            if (e.target === jsonModal) {
                closeJsonUploadModal();
            }
        });

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (modal.style.display === 'flex') {
                    closeModalFunction();
                } else if (jsonModal.style.display === 'flex') {
                    closeJsonUploadModal();
                }
            }

            // Edit mode shortcuts
            if (modal.style.display === 'flex') {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'e') {
                        e.preventDefault();
                        setEditMode(!isEditMode);
                    } else if (e.key === 's' && isEditMode) {
                        e.preventDefault();
                        saveAllChanges();
                    }
                }
            }
        });

        // JSON textarea enhancements
        jsonTextArea.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = e.target.value.substring(0, start) + '    ' + e.target.value.substring(end);
                e.target.selectionStart = e.target.selectionEnd = start + 4;
            }

            // Ctrl+Enter to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                uploadJsonData();
            }
        });

        // Field input enhancements
        document.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('field-input')) {
                if (e.key === 'Enter') {
                    e.target.blur(); // This will trigger the save
                } else if (e.key === 'Escape') {
                    // Cancel edit for this field
                    const fieldName = e.target.closest('[data-field-name]').getAttribute('data-field-name');
                    const fieldId = `field_${fieldName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const originalValue = originalFieldValues[fieldName];

                    e.target.value = originalValue || '';
                    toggleFieldEdit(fieldName, fieldId); // Switch back to display mode
                }
            }
        });

        // Auto-save on field blur
        document.addEventListener('blur', (e) => {
            if (e.target.classList.contains('field-input')) {
                const fieldName = e.target.closest('[data-field-name]').getAttribute('data-field-name');
                const fieldId = `field_${fieldName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                toggleFieldEdit(fieldName, fieldId);
            }
        }, true);

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced global functions for external use
        window.viewEndorsementCombinations = viewEndorsementCombinations;
        window.showCombination = showCombination;
        window.toggleFieldEdit = toggleFieldEdit;

        // Prevent page unload with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Check if already logged in
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const result = await apiCall('/api/auth/me');
                if (result.success) {
                    currentUser = result.user;
                    showApp();
                }
            } catch (error) {
                showLogin();
            }
        });

        // Add tooltips and help text
        document.addEventListener('DOMContentLoaded', () => {
            // Add helpful tooltips
            editModeToggle.title = 'Toggle edit mode (Ctrl+E)';
            saveAllBtn.title = 'Save all changes (Ctrl+S)';
            statusEditor.title = 'Change endorsement status';

            // Add keyboard shortcut hints
            const shortcutHints = document.createElement('div');
            shortcutHints.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--gray-800);
                color: white;
                padding: 12px 16px;
                border-radius: var(--radius-md);
                font-size: 12px;
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: 1001;
                max-width: 300px;
            `;
            shortcutHints.innerHTML = `
                <strong>Keyboard Shortcuts:</strong><br>
                • Ctrl+E: Toggle edit mode<br>
                • Ctrl+S: Save changes<br>
                • Enter: Confirm field edit<br>
                • Esc: Cancel edit/Close modal
            `;
            document.body.appendChild(shortcutHints);

            // Show hints when modal is open
            const observer = new MutationObserver(() => {
                if (modal.style.display === 'flex') {
                    shortcutHints.style.opacity = '0.8';
                } else {
                    shortcutHints.style.opacity = '0';
                }
            });
            observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
        });
        // Time Display Functions
        function updateCurrentTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });

            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }

            // Update page title with current time
            document.title = `Policy Management - ${timeString}`;
        }

        // Check server time synchronization
        async function checkServerTime() {
            try {
                const response = await apiCall('/api/system/time');
                if (response.success) {
                    const serverData = response.data;
                    const statusElement = document.getElementById('serverTimeStatus');

                    console.log('🕒 Server Time Info:');
                    console.log(`  Local: ${serverData.local_time}`);
                    console.log(`  UTC: ${serverData.utc_time}`);
                    console.log(`  Platform: ${serverData.platform}`);
                    console.log(`  Timezone: ${serverData.timezone}`);
                    console.log(`  Offset: ${serverData.offset_hours} hours`);

                    if (statusElement) {
                        statusElement.textContent = '✅ Synchronized';
                        statusElement.style.color = 'var(--accent-emerald)';
                    }

                    // Show server time info in console for debugging
                    const localTime = new Date();
                    const serverTime = new Date(serverData.local_time);
                    const timeDiff = Math.abs(localTime - serverTime) / 1000; // seconds

                    if (timeDiff > 60) { // More than 1 minute difference
                        console.warn(`⚠️ Time difference detected: ${timeDiff} seconds`);
                        if (statusElement) {
                            statusElement.textContent = `⚠️ ${timeDiff.toFixed(0)}s diff`;
                            statusElement.style.color = 'var(--warning-amber)';
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Failed to get server time:', error);
                const statusElement = document.getElementById('serverTimeStatus');
                if (statusElement) {
                    statusElement.textContent = '❌ Check Failed';
                    statusElement.style.color = 'var(--danger-red)';
                }
            }
        }

        // Update time display every second
        setInterval(updateCurrentTimeDisplay, 1000);
        updateCurrentTimeDisplay(); // Initial call

        // Check server time every 30 seconds
        setInterval(checkServerTime, 30000);
        setTimeout(checkServerTime, 2000); // Initial check after 2 seconds
    </script>
</body>

</html>
